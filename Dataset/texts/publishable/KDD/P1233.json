{
  "ABSTRACT": "Multi-agent dynamical systems refer to scenarios where multipleunits (aka agents) interact with each other and evolve collectivelyover time. For instance, peoples health conditions are mutuallyinfluenced. Receiving vaccinations not only strengthens the long-term health status of one unit but also provides protection forthose in their immediate surroundings. To make informed deci-sions in multi-agent dynamical systems, such as determining theoptimal vaccine distribution plan, it is essential for decision-makersto estimate the continuous-time counterfactual outcomes. However,existing studies of causal inference over time rely on the assump-tion that units are mutually independent, which is not valid formulti-agent dynamical systems. In this paper, we aim to bridgethis gap and study how to estimate counterfactual outcomes inmulti-agent dynamical systems. Causal inference in a multi-agentdynamical system has unique challenges: 1) Confounders are time-varying and are present in both individual unit covariates and thoseof other units; 2) Units are affected by not only their own but alsoothers treatments; 3) The treatments are naturally dynamic, suchas receiving vaccines and boosters in a seasonal manner. To thisend, we model a multi-agent dynamical system as a graph andpropose a novel model called CF-GODE (CounterFactual GraphOrdinary Differential Equations). CF-GODE is a causal model thatestimates continuous-time counterfactual outcomes in the presenceof inter-dependencies between units. To facilitate continuous-timeestimation, we propose Treatment-Induced GraphODE, a novel ordi-nary differential equation based on graph neural networks (GNNs),which can incorporate dynamical treatments as additional inputs topredict potential outcomes over time. To remove confounding bias,we propose two domain adversarial learning based objectives thatlearn balanced continuous representation trajectories, which arenot predictive of treatments and interference. We further providetheoretical justification to prove their effectiveness. Experiments ontwo semi-synthetic datasets confirm that CF-GODE outperforms Permission to make digital or hard copies of part or all of this work for personal orclassroom use is granted without fee provided that copies are not made or distributedfor profit or commercial advantage and that copies bear this notice and the full citationon the first page. Copyrights for third-party components of this work must be honored.For all other uses, contact the owner/author(s).KDD 23, August 610, 2023, Long Beach, CA, USA 2023 Copyright held by the owner/author(s).ACM ISBN 979-8-4007-0103-0/23/08.",
  "INTRODUCTION": "Estimating counterfactual outcomes over time is critical to gain-ing causal understanding for many useful practical applications,such as how to distribute the limited vaccines in the early daysto maximize protection over time , or how to design properscheduling of medical treatments to optimize the patient recov-ery process . Randomized controlled trials (RCTs) are the goldstandard for causal inference, but they can be cost-prohibitive andethically challenging, particularly when considering the dynamicalsettings described above. Therefore, estimating counterfactual out-comes from observational data is the key approach to answeringcausal questions in real-world scenarios. Existing research on ob-servational causal inference over time has begun by utilizing basiclinear regression and Gaussian processes to capture thetime-dependencies. Subsequently, advancements have been madeby incorporating more advanced deep learning models such asrecurrent neural networks (RNNs) and Transformers .Despite the progress, all aforementioned studies have relied onthe assumption that units (e.g., people in the vaccine example)are independent of each other, i.e., each unit is solely influencedby its own treatment but not by others. In many realistic scenar-ios, however, this assumption is not valid. For instance, a personsvaccination not only protects themselves but also those close tothem. This type of setting is referred to as a multi-agent dynami-cal system , where units (also known as agents) interact witheach other and evolve collectively over time. Many practical prob-lems can be expressed as multi-agent dynamical systems, such as",
  ": Causal graph at time in a multi-agent dynamicalsystem. The causal variables are represented by shapes, whiletheir relationships are distinguished by colors": "the long-term effects of vaccination where people mutually influ-ence , brain network signals in which the regions of interest(ROI) in a brain are associated , and molecular systems move-ments where the atoms are interconnected . Prior approachesfor causal inference over time are not applicable to multi-agentdynamical systems since they are not capable of handling the inter-connections between units. In this paper, we propose to study thisnovel problem counterfactual estimation in multi-agent dynamicalsystems, which has received limited attention in the literature.The dynamic and interrelated nature of multi-agent dynami-cal systems poses unique and nontrivial challenges to causal in-ference. We illustrate them along with . 1) Multi-sourceconfounders. Confounders are variables that have an impact onboth treatments and outcomes, leading to spurious correlationsbetween them. Therefore, in observational data, the treatmentsare not balanced among units with different confounders values,resulting in biased counterfactual outcomes estimation. For ex-ample, old people are more likely to receive vaccines, but alsoface a higher risk of virus infection. If we train a standard super-vised model using such imbalanced data, it may wrongly predictthat vaccines may increase the infection risk for young people. Inmulti-agent dynamical systems, the confounders are multi-source,including time-dependent confounders and neighbor confounders.Time-dependent confounders refer to the fact that the confounderstypically evolve over time and thus their impact on treatments andoutcomes also changes dynamically . For instance, peopleshealth conditions change over time, affecting their likelihood ofgetting vaccinated and future health status. Neighbor confoundersmean that a units treatment and outcome could also be confoundedby the covariates of its near units (neighbors) , For example,if family members are in poor health, a unit may be more likely toreceive a vaccine. Compared to the independent setting, neighborconfounders are additional confounding factors in multi-agent dy-namical systems. 2) Imbalance of interference. As discussed inthe previous example that vaccines protect not only a unit but alsothose in close proximity, the outcome of a unit can be influenced byothers treatments in multi-agent dynamical systems. In causal lan-guage, this phenomenon is referred to as interference. Similar to thetreatments, interference is affected by the covariates and thus is notbalanced across the units in observational data . For instance,highly educated units are more likely to receive vaccines and typi-cally have more highly educated friends. Therefore, they receivestronger protection through higher vaccination rates among their social networks. Such imbalanced interference causes additionalbias in the estimation of counterfactual outcomes. 3) Continuousdynamics. In realistic applications, a multi-agent dynamical systemis continuous in nature . However, most existing causal modelsare discrete, making them inappropriate for multi-agent dynamicalsystems. Modeling continuous-time observations (such as covari-ates and outcomes) and continuously estimating counterfactualoutcomes over time remains an open challenge.In this paper, we address the above challenges and study how toestimate continuous-time counterfactual outcomes, in presence ofmulti-source confounders and interference, in multi-agent dynam-ical systems. This is a novel, yet challenging and under-exploredproblem with valuable real-world applications.To this end, we model a multi-agent dynamical system as agraph, where nodes represent units and edges capture their interac-tions. Inspired by recent achievements in graph ordinary differentialequations (GraphODE) , we propose CF-GODE, a novel causalmodel that estimates continuous-time CounterFactual outcomesbased on Graph Ordinary Differential Equations in multi-agentdynamical systems. Specifically, we use GraphODE as a backboneto model the continuous trajectory of each unit. However, in thiscase, traditional GraphODE can only model the pure dynamics ofpotential outcomes and lacks the ability to incorporate ad-ditional inputs such as treatments, making it inappropriate forcausal inference. To address this issue, in CF-GODE, we proposeTreatment-Induced GraphODE, a new GraphODE model capable ofhandling treatments when predicting the future trajectory of po-tential outcomes. Treatment-Induced GraphODE uses graph neuralnetworks (GNNs) to formulate its differential equations, whichcan effectively capture the mutual dependencies between units in-cluding neighbor confounders and interference. This advantagemakes it a natural fit for counterfactual estimation in multi-agentdynamical systems. Then a latent representation is learned for eachunit from its observations as the solution to Treatment-InducedGraphODE, which represents the continuous trajectory driven bytreatments. The core of ensuring CF-GODE is a causal model is todeal with the aforementioned estimation bias caused by imbalancedtreatments and interference in the observational data. We solve thisissue via domain adversarial learning , in which we treat thevalues of treatments (and interference) as domains and ensure thelatent representation trajectories are invariant to them. We providetheoretical justification to demonstrate that the domain-adversarialbalancing objective functions proposed in CF-GODE can effectivelyachieve the balancing goal, thereby removing bias in counterfactualestimation and ensuring that CF-GODE is causal.We summarize our major contributions as follows: 1) We studyhow to estimate counterfactual outcomes in multi-agent dynami-cal systems, which is a novel yet challenging problem with usefulpractical implications. 2) We propose CF-GODE, a novel causalmodel for causal inference multi-agent dynamical systems basedon GraphODE and domain-adversarial learning. 3) We providetheoretical analysis to show that CF-GODE is able to handle theimbalanced treatments and interference, ensuring unbiased counter-factual estimation. 4)We conduct extensive experiments to evaluateCF-GODEs performance on counterfactual outcomes estimationin multi-agent dynamical systems.",
  "RELATED WORK2.1Causal Inference Over Time": "The central challenge in estimating counterfactual outcomes inlongitudinal settings is to remove the confounding bias from time-dependent covariates . The core solution to this in existingworks is to cut off the association between covariates and the ob-served treatment assignments over time. To achieve this goal, sta-tistical tools are widely used in traditional approaches. For example,marginal structural models (MSMs) use inverse probability oftreatment weighting (IPTW) to balance the distributionof covariates over time between unit groups that are assigned todifferent treatments. By doing so, treatment assignment can nolonger be predicted from the balanced covariates, thus breakingtheir correlation. A later work further enhances MSMs byusing recurrent neural networks (RNNs) to learn the inverse prob-ability of treatment weights (IPTWs), which is more capable ofmodeling sequential data. However, IPTW based tools can result inhigh variances in practice . To overcome this limitation, recentstudies extend the representation learning based balancingapproaches from static settings to dynamic settings.Specifically, counterfactual recurrent network (CRN) uses RNNsto encode the time-varying covariates into latent embeddings overtime, which are simultaneously optimized by two objectives: po-tential outcomes prediction and longitudinal distribution balancingw.r.t. treatment assignments. The learned balanced embeddings arenot predictive of treatments, thus ensuring unbiased estimates of thepotential outcomes. Since RNNs are less powerful in capturing long-range dependencies, improves CRN by using Transformer that preserves long-range dependencies between time-dependentconfounders. Despite the progress, all the above models can onlypredict counterfactual outcomes in discrete timestamps. However,practical longitudinal sequences are continuous in nature.Our work is most related to , which estimate coun-terfactual outcomes in continuous dynamic settings using neuralordinary differential equations (ODEs) or neural controlleddifferential equations (CDEs) . Specifically, infers contin-uous latent trajectories to represent the movement of potentialoutcomes and balance the distribution of this latent representationbetween treated and control groups via adversarial learning. How-ever, (and all aforementioned models) assume that units aremutually independent, which is usually not valid in many practicalscenarios where the units affect each other, e.g., getting vaccinatedprovides long-term protection not only for oneself but also fortheir close ones. In contrast, our model is designed to estimatecounterfactual outcomes in longitudinal settings where units areinterdependent, i.e., the multi-agent dynamical systems.",
  "Continuous Modeling With Neural OrdinaryDifferential Equations (ODEs)": "Many dynamical systems are continuous in nature, which canbe typically modeled using first-order ordinary differential equa-tions (ODEs) . ODEs describe a systems rate of change overtime by a specific function, which is traditionally designed by do-main experts , and more recently parameterized by neural net-works , as a closed-form ODE function may be unknown for some complex real-world systems. Given initial states, the solu-tion of a NeuralODE can be easily computed using any ODE solver,such as the Runge-Kutta method . In multi-agent dynamicalsystems, such as the spread of infectious disease among people,units often interact with one another, yet standard NeuralODEs donot explicitly model these interactions. Recent works have soughtto address this limitation by representing the interactions amongmultiple units as graphs, and then utilizing graph neural networks(GNNs) to parameterize the ODE function .When predicting the dynamics of each unit, these GraphODE mod-els not only take into account the units own latent state but alsoaggregate the latent states of its connected units along the inter-action graph, to effectively capture the mutual influence betweenthem. However, GraphODE models are standard statistical methodsand therefore lack the capability for causal inference. Instead, ourmodel aims to address the unique challenges present in multi-agentdynamical systems, i.e., time-dependent confounders and networkinterference, in order to make counterfactual predictions.",
  "PROBLEM SETUP3.1Problem Formulation": "We study how to estimate counterfactual outcomes in the context ofmulti-agent dynamical systems, where the units engage in mutualinteractions and evolve simultaneously over time. Throughout thispaper, we use boldface uppercase letters to denote matrices or vec-tors, boldface uppercase letters with subscripts to signify elementsof matrices or vectors, regular lowercase letters to represent valuesof variables, and calligraphic uppercase letters to indicate sets. Wesummarize all notations used in this paper in Appendix. A.4.Formally, a multi-agent dynamical system can be represented bya dynamical graph G = (V, E), where V = {1, 2, ..., } is theset of units (nodes) and E denotes the edge set at time . An edgein E describes the intersection between the two units it connectsat time . In this paper, we present an early exploration of causalinference in multi-agent dynamical systems, and for the purpose ofsimplicity, we assume that the graph structure remains constantover time, i.e., G = G. Each unit is associated with time-varyingvariables, which are the causal quantities in our case. We introducethem together with the causal framework in the following.We follow the longitudinal potential outcomes framework to formalize the counterfactual outcome estimation as in .The observational data X, A, Y V in a multi-agent dynam-ical system contains time-dependent covariates X (e.g., healthcondition), dynamical treatments A (e.g., vaccine allocation), andtime-varying outcomes Y (e.g., immunity to infectious disease). Itis worth noting that Y is essentially a part of X. V denotes thestatic covariates of units such as ethnicity. Let the historical recordsof the multi-agent dynamical system up to time be representedby H = { X, A, Y, V}, where X, A, Y are all the X , A , Y until ( ), respectively. In causal inference, we are focusedon understanding the potential outcomes Y+ (A+ = )1 that mayoccur in the future (+ > ) under a specific treatment , whichexplains the impact of the treatment assignment on the dynamicsof the system. Note that is a treatment trajectory that includes",
  "Underlying Outcome Continuous Trajectory": ": Overview of CF-GODE. The initial latent represen-tation Z0 is first learned from initial observations. Then thecontinuous latent representation trajectory Zt is learned asthe solution to treatment-induced GraphODE, which is ableto handle treatments as additional inputs. The graph neuralnetwork (GNN) based ODE function naturally models themutual dependencies. The future potential outcomes can bedecoded from Zt at any given time. To remove confoundingbias, Zt is balanced with respect to 1) treatments, 2) interfer-ence when combined with corresponding treatments.",
  "Causal Identification": "The potential outcomes represented by Y+ (A+ = ) are a causalquantity. To make it identifiable from observational data, we mustadhere to the following necessary assumptions.Assumption 1: Positivity (Overlap). The future treatmenttrajectory is probabilistic regardless of the historical observation,i.e., 0 < (A+ = | H) < 1, H.Assumption 2: Consistency. Under the same treatment trajec-tory , the potential outcome is equal to the observed outcomes,i.e., Yt+ (A+ = ) = +.The above two assumptions are standard for longitudinal coun-terfactual estimation. To identify the potential outcomes, it is alsonecessary to assume that there are no unobserved confounders, i.e.,the strong ignorability assumption. However, the typical sequentialstrong ignorability assumption is not appropriatefor multi-agent dynamical systems, because the graph structureG introduces extra graph confounders and interference. A plausi-ble strong ignorability assumption for graphs is first introducedby and later validated in studies such as . However,the assumption made in these works is limited to static settings. Toaddress this, we extend it to longitudinal settings and adapt it to beapplicable to multi-agent dynamical systems in the following.We first introduce a summary function, denoted as (), thatcaptures the interference effects caused by the treatments of anodes neighboring units in the graph as in . Formally, G =(AN, AN ), where AN denotes the treatments of node s im-mediate neighbors, and AN is the treatments of all the remain-ing node that are not directly connected to node . We refer to",
  "treated units in unit s neighbors, i.e., G := NA": "| | . WithG , we present the strong ignorability assumption for multi-agentdynamical systems in the following:Assumption 3: Strong Ignorability for Multi-Agent Dynam-ical Systems2. Given the historical observations and the graphstructure that describes the multi-agent dynamical system, the po-tential outcome trajectory is independent of the treatments andinterference summary, i.e., Yt+ (A+ = ) A+, G+ | H, G.,.With these three assumptions, the potential outcome trajectoryEq. (1) can be identifiable as:",
  "= EY+ | A+, G+, H, G.(3)": "Eq. (2) is true because of assumption 3, while Eq. (3) holds underthe assumption 2. The above causal identification enables us toestimate the potential outcomes in multi-agent dynamical systemsusing observational data. More specifically, we can train a machinelearning model on observational data, which takes treatment tra-jectory A+, interference summary G+, historical observation H and graph G as inputs, and the observed (factual) outcome Y+ astargets, to predict the counterfactual outcomes given new treatmenttrajectories. Our proposed model CF-GODE is grounded in this andwill be presented in detail in the subsequent section.",
  "PROPOSED MODEL: CF-GODE4.1Overview": "Our proposed CF-GODE is a causal model that predicts counter-factual outcomes in a multi-agent dynamical system by learningfrom observational data. We show an overview of our model in. Compared to most existing causal models designed for stan-dard sequential settings that consider discrete time intervals andindependent units , multi-agent dynamical systems are morerealistic and present two challenging properties: the dynamics arecontinuous in nature, and units are influenced by others. To addressthese, our proposed CF-GODE takes the advantage of recent break-throughs in graph ordinary differential equations (GraphODE) and extends it to handle treatments and interference, enablingcontinuous estimation of counterfactual outcomes in multi-agentdynamical systems. We refer to our ODE model as Treatment-Induced GraphODE (Sec. 4.2). The time-dependent confounderslead the distribution of covariates to be quite discrepant betweenunits assigned to different treatments, resulting in high variancesin counterfactual outcome estimation . This effect is fur-ther amplified by the imbalanced interference caused by the graph",
  "Treatment-Induced GraphODE": "To facilitate continuous-time counterfactual outcome estimation,we propose to learn a continuous latent trajectory Z for every nodein multi-agent dynamical system that represents their movement.An ideal Z should possess two characteristics: 1) the ability to pre-dict observed outcomes, and 2) not to be predictive of the receivedtreatment or interference in observational data3. We implementsuch a Z by a novel model called Treatment-Induced GraphODE,which empowers the recent GraphODE to deal with treat-ment and interference for counterfactual outcomes estimation.In a multi-agent dynamical system, the future outcomes of node might be affected by not only its own past movement and currenttreatment, but also the movements and interference from neighbors(e.g., a units health condition and vaccination status have a signifi-cant impact on how likely others are to be infected). We model thisprocess and formalize treatment-induced GraphODE as:",
  "=0Z, A.(4)": "In Eq. (4), Z and A denote the latent trajectory representationsand treatments of all nodes in the multi-agent dynamical system,respectively. () is the ODE function. To comprehensively capturethe effects from node and its connected neighbors, we parame-terize () using graph neural networks with self-loops. Z0 isthe initial state and can be encoded from the initial observations asZ0 = (X0 , V), where () is an encoder parameterized by neuralnetworks. With Z0 , we can obtain the Z , which is the solutionto treatment-induced GraphODE, by solving an ODE initial-valueproblem (IVP) in Eq. (4), formalized as:",
  "Z0 , Z1 Z = ODESolve, [Z01, Z02 Z0 ], (0,1 ), (5)": "where is the number of timestamps for the evaluation of Eq. (5).With the solution latent trajectory Z , we can then use a decoderY() to transform it to the predicted outcome Y = Y(Z ). We alsouse neural networks to instantiateY(). We compare the predictionY to ground-truths Y in all observed timestamps (0,1 )using a mean square error as objective, which is formalized as:",
  "Balancing via Adversarial Learning": "In the observational data, the treatments applied to each unit Aare affected by the time-dependent confounders present in thecovariates (and thus in its latent representation trajectory Z ). Con-sequently, the distribution of latent representation trajectory is notbalanced among units with different treatment assignments, i.e.,(A |Z ) is not uniform, leading to high variances in the counter-factual outcome estimation . In the context of multi-agentdynamical systems, this effect is further exacerbated by the pres-ence of imbalanced interference among units. This is because a units",
  "The second characteristic is discussed in Sec. 4.3": "interference is influenced by its covariates (also the latent represen-tation) and treatments in the observational data, i.e., (G |Z, A )is not uniform . Here we give an intuitive example of theimbalanced interference: consider that a highly educated personis more likely to be surrounded by other highly educated friends,who believe in science and are more likely to be vaccinated, therebyproviding stronger protection for this person against infectiousdiseases, i.e., higher interference.A sufficient condition to remove the above bias is to ensure thatthe distribution of latent representation trajectories is invariantto treatments, and when combined with the corresponding treat-ments, is interference-invariant . This condition isformalized as (Z |A = 0) = (Z |A = 1) for treatment balancing,and (Z, A |G = ) is identical for any given value of forinterference balancing. The treatment A is binary and interfer-ence G is continuous as in . Note that the aforementionedconditions are over the unit groups. This guarantees that the treat-ment cannot be inferred from the latent representation trajectory,and that the interference is not predictable when the treatment iscombined with latent representation. We implement this balancinggoal through domain adversarial learning , in which the treat-ment is treated as binary domains and the interference is treated ascontinuous domains . Specifically, we use the gradient reversallayer proposed in , denoted as (), to adversarially optimizethe latent representation trajectory at every observed time, makingit agnostic towards the treatments and interference.Treatment Balancing. Formally, the predicted treatment isA = A (Z ), where the A is a neural network that attemptsto recover the treatment from latent representation. The gradientreversal layer () does nothing in the forward pass, but reversesthe gradients in the back-propagation. This way, a min-max gameis created in which A aims to minimize the treatment predictionloss, while the latent representation learner in treatment-inducedGraphODE strives to maximize it, as formalized in the following:",
  "where A represents the logits of A() for predicting treatment .We then provide a theoretical analysis to justify the capability of to attain balanced representations in the following": "Theorem 1. Let {0, 1} be the binary treatment values, andlet and denote the number of units and observed timestamplengths, respectively. Let = (Z | A = ), be the distributionof latent representation Z for the group of units with treatments at time . Let , , A be the initial state encoder, the ODE functionof treatment-induced GraphODE, and logits of predicting treatment. The necessary and sufficient condition for the min-max game inEq. (7) to be optimal is 0 = 1, (0,1 ). Theorem 1 suggests that the condition to obtain global optimumof Eq. (7) is (Z |A = 0) = (Z |A = 1). Therefore, by optimizing in Eq. (7), we can ensure the latent representation trajectoryZ is balanced with respect to treatments. In other words, Z is notpredictive of A. We prove Theorem 1 in Appendix. A.1.1.",
  "G ([Z, A ]) G2(8)": "where G is the interference predictor which is parameterized byneural networks, and is the concatenation operation. In thefollowing, we also theoretically demonstrate that is able toachieve the interference balancing objective. Theorem 2. Let , , G be the initial state encoder, the ODE func-tion of treatment-induced GraphODE, and the interference predictor.The necessary and sufficient condition for min-max game in Eq. (8)to be optimal is (Z, A |G = ) is identical for any . Theorem. 2 indicates that if E([Z, A] | G) is identical for anyG = , Eq. (8) achieves optimum. Therefore, it is sufficient tobalance the combination of representations and treatments withrespect to interference G by optimizing the objective function. We show the proof of Theorem 2 in Appendix. A.1.2.",
  "= + A + G,(9)": "where coefficients A, G are the strengths of the treatment bal-ancing and interference balancing, respectively. By adversariallyoptimizing , the latent representation trajectory Z is able to pre-dict the outcome trajectory Y while remaining invariant to thetreatments A and interference G (combined with treatments),which enables the unbiased counterfactual outcome estimation inmulti-agent dynamical systems.Alternative Training as Trade-Off. In practice, we find thatdirectly training CF-GODE with the overall loss function maynot be stable as and could hinder the ability of latentrepresentation trajectory Z to predict the outcome. Therefore,we trade-off the training of CF-GODE in an alternative mannerbetween and , to ensure that Z is capable of predictingoutcomes. Specifically, we switch the training iterations between and with a ratio of , i.e.,",
  "EXPERIMENTS5.1Experimental Settings": "Dataset. In observational data, we only have factual outcomes butnot counterfactual outcomes. Therefore, we use semi-syntheticsdata to evaluate CF-GODE as in . That is, we use two realgraphs Flickr and BlogCatalog and use a Pharmacokinetic-Pharmacodynamic (PK-PD) model to simulate the continuoustrajectory of treatments and potential outcomes . The data simulation mimics the vaccine example in the real world. We intro-duce the data simulation process in detail in Appendix. A.3.Metric. We focus on counterfactual outcomes estimation inthis paper, which is a continuous value. Therefore, we use meansquare errors (MSE) as our metric to evaluate the performance of",
  "our model, which is formalized as := 1": "1Y Y2.Baselines. The scope of our model is in continuous-time causalinference, therefore we compare CF-GODE with the following base-lines: CDE : Ordinary differential equations with external in-puts to adjust the continuous trajectory. GraphODE Ordinarydifferential equations model with graph neural networks (GNNs)based ODE functions. TE-CDE : the state-of-the-art modelfor continuous-time counterfactual outcomes estimation based onneural controlled differential equations (NeuralCDE).Implementation. The parameters of CF-GODE are set as fol-lows: the dimension of latent representations is 64; the ODE solveris the Euler method; the balancing degrees are A = G = 0.5. Fortraining hyperparameters, the learning rate is 0.0001; the defaultalternative training ratio is 4. We train the model 5000 epochsand select the best model according to the performance on thevalidation set. The parameters are optimized by Adam . We runall experiments on a Lambda Labs instance with one A100 GPU. : Counterfactual outcomes estimation errors on twodatasets. BC is the abbreviation of the BlogCatalog dataset.The errors are broken down in x-step future estimation( ). MSE errors are reported. The best resultsare in boldface and the second best results are underlined.CF-GODE-N is the variant of our model without any bal-ancing; CF-GODE-T means balance only w.r.t. treatments;CF-GODE-I denotes balance only w.r.t. interference.",
  "CF-GODE: Continuous-Time Causal Inference forMulti-Agent Dynamical SystemsKDD 23, August 610, 2023, Long Beach, CA, USA": "During the simulation, we follow this protocol: the health condi-tion X has a value range [0.1, 10], in which a higher value meansa better health condition. Meanwhile, a higher health conditionmeans a lower probability to receive a vaccine (treatment).Treatment simulation. The treatment A is affected by a unitsown time-dependent covariates X , static covariates V and thoseof their neighbors. Let E = V denote the effects of staticconfounders on treatments, where is a generated parameterrepresenting this mechanism. The treatment is then simulated byBernoulli generator with probability the () of unit at time :",
  "After Flipping Treatments": ": T-SNE projections of latent representations before(factual) and after (counterfactual) flipping the treatments.Each point represents a units latent representation. Thepoints are colored by the units corresponding interference.Upper row: Flickr dataset; Lower Row: BlogCatalog dataset. Why Does CF-GODE-T Show Superior Performance ThanCF-GODE on BlogCatalog Dataset? On BlogCatalog dataset, weobserve that balancing solely with respect to treatments (CF-GODE-T) yields the lowest estimation errors, even outperforming balanc-ing both treatments and interference (CF-GODE). To understandthis phenomenon, we project all units latent representations Z into 2-D embeddings using T-SNE and color these 2-D pointsby their corresponding interference in . Specifically, we com-pare the units interference before and after flipping the treatments.Compared to Flickr, we notice that in BlogCatalog 1) the latentrepresentations are already comparatively more balanced beforeflipping the treatments, and 2) the units interference does notchange significantly after flipping the treatments. This suggeststhat balancing solely with respect to treatments might be sufficient in the BlogCatalog dataset. Actually, since we use the same datasimulation protocol for Flickr and BlogCatalog, this difference ininterference distribution is expected to be caused by their distinctgraph structures. Specifically, the average and standard derivationof node degrees of the two datasets are Flickr: 2.0 1.7; BlogCata-log: 30.7 25.1. Intuitively, the interference of high degrees nodesis more resistant to flipping a random portion of their neighbors,which is pretty common among nodes in BlogCatalog. We providefurther breakdown studies to better understand how node degreesaffect counterfactual outcomes estimation in Sec. 5.5.",
  "How Does CF-GODE Respond to TheFlipping of Counterfactual Treatments?": "In the above experiments, the default treatment flipping ratio isset at 50%. Its intriguing to investigate how CF-GODE reacts todifferent flipping ratios, as this would indicate the degree of dif-ference between factual and counterfactual outcomes in terms oftreatments. To this end, we set the flip ratio as [25%, 50%, 75%, 100%],and present the results of CF-GODE and its variants under thesesettings in . As expected, all models perform worse as theflip ratio increases, since the counterfactual treatments diverge fur-ther from the observed factual treatments. However, we observethat with balancing objectives, the error of CF-GODE increasesgenerally slowly, highlighting the need for balancing objectives. : Counterfactual outcomes estimation errors w.r.t.11 different confounding degrees and . Note and are set as the same values in each experiment. The red linepoints to the no confounding bias setting ( = = 0).",
  "KDD 23, August 610, 2023, Long Beach, CA, USASong Jiang, Zijie Huang, Xiao Luo and Yizhou Sun": "values of these coefficients, the confounding bias is more severe,leading to increasingly imbalanced data. To study how CF-GODEworks under varying confounding degrees, we set = = ,where , and present the counterfactualoutcomes estimation errors of CF-GODE under these conditions in. The errors increase as the confounding bias becomes moresevere, but the rate of increase is relatively smooth, particularlyon Flickr dataset. This implicates CF-GODEs robustness againsthigh degree confounding bias. Additionally, CF-GODE produceslow errors when there is no confounding bias ( = = 0), whichdemonstrates the compatibility of CF-GODE with such settings.",
  "How Does Graph Structure ImpactCounterfactual Outcomes Estimation?": "As discussed in Sec. 5.2, the graph structure affects CF-GODEs per-formance on counterfactual outcomes estimation. To gain deeperinsights into this phenomenon, we break down the estimation er-rors on BlogCatalog dataset according to node degrees in Table. 2.Interestingly, we find that CF-GODEs counterfactual estimationerrors decrease as the node degrees become higher. Intuitively, thismight also be because the interference of high-degree nodes ismore stable. However, in this paper, we do not have a theoreticalunderstanding of the relationships between estimation errors andnode degrees. We leave this line of research in future study.",
  "Can CF-GODE Be Generalized to NewMulti-Agent Dynamical Systems?": "Standard counterfactual outcome estimations are typically con-ducted on units whose factual outcomes have been observed. How-ever, the estimation of the potential outcomes on new multi-agentdynamical systems is also of great importance. For instance, topredict the effects of an initial vaccine distribution strategy for anew community. To assess CF-GODEs ability to generalize to newsystems, i.e., new graphs, we split the original graph into threesubgraphs, denoted as training/validation/testing graphs (details inAppendix. A.3). We train our model on the training graph and evalu-ate its potential outcome estimation on the testing graph. We reportthe results in Table. 3. We note that the performance of CF-GODEand the variants on new graphs are also generally better than base-lines, which is consistent with the estimation of the counterfactualoutcomes within the same graph (Sec. 5.2). This demonstrates ourmodels generalizability to new multi-agent dynamical systems. : Generalization errors of potential outcomes predic-tion for new multi-agent dynamical systems (new graphs)on two datasets. BC is the abbreviation of the BlogCat-alog dataset. The errors are broken down in x-step futureestimation ( ). MSE errors are reported. Thebest results are in boldface and the second best results areunderlined. CF-GODE-N is the variant of our model withoutany balancing; CF-GODE-T means balance only w.r.t. treat-ments; CF-GODE-I denotes balance only w.r.t. interference.",
  "represents the alternating training": "between the overall loss and the outcome prediction loss . shows the 2-D T-SNE projections of latent representationsand their corresponding counterfactual estimation errors for differ-ent K values. We note that compared to solely training on (i.e.,no balancing), training with is able to force the embeddings morebalanced, suggesting the effectiveness of our proposed domain ad-versarial learning based balancing objectives. In addition, with asmaller , CF-GODE achieves better estimation errors, while a big-ger leads to more balanced latent representations. These resultsconfirm that our alternative training is able to trade off betweenlatent representation balancing and potential outcome prediction.In practice, choosing an appropriate value of is expected to bedetermined through empirical analysis for each dataset.",
  "Case Study: When CF-GODE Is Good, andWhen It Is Not": "To intuitively understand how CF-GODE works in estimating coun-terfactual outcomes and to study when CF-GODE would fail, wesample one successful unit and one failure unit from Flickr dataset.We draw their factual outcomes, counterfactual outcomes, and theestimations made by CF-GODE and CF-GODE-N (without balanc-ing) in . In the successful case, the estimate by CF-GODE isable to conform to the counterfactual treatment trajectory, while",
  "are attached around the corresponding curves at each times-tamp. The estimation errors are noted in blue. Results arefrom Flickr dataset. Left: a successful case; right: a bad case": "CF-GODE-N still follows the factual trajectory. This shows the effec-tiveness of our proposed balancing objectives. However, CF-GODEalso makes mistakes. In the failure case, its estimate fails to catch upwith the counterfactual outcome trajectory, yielding a non-trivialerror. We speculate that this is because the counterfactual outcomeof this unit is quite distinct from the factual one in terms of datascale, making counterfactual estimation more difficult.",
  "How Hyperparamters Affect CF-GODE?": "The two balancing objectives are core to making CF-GODE causal.Therefore, we finally study the impact of their degrees, representedby A and G in the loss function, on the model performance. Wetest A and G values evenly ranging from [0, 0, 1.0], and presentthe counterfactual outcomes estimation errors for each combina-tion of A and G in . Our results show that the errors arerelatively higher when both A and G are in low values, i.e., lightbalancing. On the other hand, with larger values, the estimation er-rors generally become lower, but with high variance. This indicates",
  "CONCLUSION": "In this paper, we study continuous-time counterfactual outcomesestimation in multi-agent dynamical systems, where units inter-act with each other. To this end, we propose CF-GODE, a novelcausal model based on GraphODE to enable continuous potentialoutcomes prediction, and domain adversarial learning to removeconfounding bias. We provide both theoretical justification andempirical analyses to demonstrate the effectiveness of our model.One limitation of CF-GODE is it needs the assumption of strong ig-norability for multi-agent dynamical systems, which is not testablein practice. Recent studies relax this assumption by inferring latentproxy variables , which could be a potential solution. This work was partially supported by NSF 2211557, NSF 1937599,NSF 2119643, NSF 2303037, NASA, SRC, Okawa Foundation Grant,Amazon Research Awards, Cisco research grant, Picsart Gifts, andSnapchat Gifts.",
  "Ricky TQ Chen, Yulia Rubanova, Jesse Bettencourt, and David K Duvenaud. 2018.Neural ordinary differential equations. Advances in neural information processingsystems 31 (2018)": "Zhixuan Chu, Stephen L Rathbun, and Sheng Li. 2021. Graph infomax adversariallearning for treatment effect estimation with networked observational data. InProceedings of the 27th ACM SIGKDD Conference on Knowledge Discovery & DataMining. 176184. Hejie Cui, Wei Dai, Yanqiao Zhu, Xuan Kan, Antonio Aodong Chen Gu, JoshuaLukemire, Liang Zhan, Lifang He, Ying Guo, and Carl Yang. 2022. BrainGB:a benchmark for brain network analysis with graph neural networks. IEEETransactions on Medical Imaging (2022). Edward De Brouwer, Javier Gonzalez, and Stephanie Hyland. 2022. Predictingthe impact of treatments over time with uncertainty aware neural differentialequations.. In International Conference on Artificial Intelligence and Statistics.PMLR, 47054722.",
  "Jacob D Durrant and J Andrew McCammon. 2011. Molecular dynamics simula-tions and drug discovery. BMC biology 9, 1 (2011), 19": "Laura Forastiere, Edoardo M Airoldi, and Fabrizia Mealli. 2021. Identificationand estimation of treatment and interference effects in observational studies onnetworks. J. Amer. Statist. Assoc. 116, 534 (2021), 901918. Keisuke Fujii, Koh Takeuchi, Atsushi Kuribayashi, Naoya Takeishi, YoshinobuKawahara, and Kazuya Takeda. 2022. Estimating counterfactual treatment out-comes over time in multi-vehicle simulation. In Proceedings of the 30th Interna-tional Conference on Advances in Geographic Information Systems. 14. Yaroslav Ganin, Evgeniya Ustinova, Hana Ajakan, Pascal Germain, HugoLarochelle, Franois Laviolette, Mario Marchand, and Victor Lempitsky. 2016.Domain-adversarial training of neural networks. The journal of machine learningresearch 17, 1 (2016), 20962030. Veysel Gazi and Bar Fidan. 2007. Coordination and control of multi-agentdynamic systems: Models and approaches. In Swarm Robotics: Second InternationalWorkshop, SAB 2006, Rome, Italy, September 30-October 1, 2006, Revised SelectedPapers 2. Springer, 71102. Changran Geng, Harald Paganetti, and Clemens Grassberger. 2017. Predictionof treatment response for combined chemo-and radiation therapy for non-smallcell lung cancer patients using a bio-mathematical model. Scientific reports 7, 1(2017), 13542. Sylvain Goutelle, Michel Maurin, Florent Rougier, Xavier Barbaut, Laurent Bour-guignon, Michel Ducher, and Pascal Maire. 2008. The Hill equation: a review of itscapabilities in pharmacological modelling. Fundamental & clinical pharmacology22, 6 (2008), 633648. Ruocheng Guo, Jundong Li, and Huan Liu. 2020. Learning individual causaleffects from networked observational data. In Proceedings of the 13th InternationalConference on Web Search and Data Mining. 232240. Daehoon Gwak, Gyuhyeon Sim, Michael Poli, Stefano Massaroli, Jaegul Choo,and Edward Choi. 2020. Neural ordinary differential equations for interventionmodeling. arXiv preprint arXiv:2010.08304 (2020).",
  "Information Processing Systems 33 (2020), 66966707": "Diederik P. Kingma and Jimmy Ba. 2015. Adam: A Method for Stochastic Opti-mization. In 3rd International Conference on Learning Representations, ICLR 2015,San Diego, CA, USA, May 7-9, 2015, Conference Track Proceedings. Thomas N. Kipf and Max Welling. 2017. Semi-Supervised Classification withGraph Convolutional Networks. In 5th International Conference on LearningRepresentations, ICLR 2017, Toulon, France, April 24-26, 2017, Conference TrackProceedings. Bryan Lim, Ahmed Alaa, and Mihaela Van Der Schaar. 2018. Forecasting treatmentresponses over time using recurrent marginal structural networks. advances inneural information processing systems 31 (2018). Jing Ma, Ruocheng Guo, Chen Chen, Aidong Zhang, and Jundong Li. 2021. De-confounding with networked observational data in a dynamic environment. InProceedings of the 14th ACM International Conference on Web Search and DataMining. 166174. Jing Ma, Mengting Wan, Longqi Yang, Jundong Li, Brent Hecht, and Jaime Teevan.2022. Learning causal effects on hypergraphs. In Proceedings of the 28th ACMSIGKDD Conference on Knowledge Discovery and Data Mining. 12021212. Yunpu Ma and Volker Tresp. 2021. Causal inference under networked interferenceand intervention policy enhancement. In International Conference on ArtificialIntelligence and Statistics. PMLR, 37003708.",
  "Jan Medlock and Alison P Galvani. 2009. Optimizing influenza vaccine distribu-tion. Science 325, 5948 (2009), 17051708": "Valentyn Melnychuk, Dennis Frauen, and Stefan Feuerriegel. 2022. Causal Trans-former for Estimating Counterfactual Outcomes. In International Conference onMachine Learning, ICML 2022, 17-23 July 2022, Baltimore, Maryland, USA (Pro-ceedings of Machine Learning Research, Vol. 162). PMLR, 1529315329. Judea Pearl. 2009. Causality. Cambridge university press. Robert W Platt, Enrique F Schisterman, and Stephen R Cole. 2009. Time-modifiedconfounding. American journal of epidemiology 170, 6 (2009), 687694.",
  "Yanbo Xu, Yanxun Xu, and Suchi Saria. 2016. A Bayesian nonparametric approachfor estimating individualized treatment-response curves. In Machine learning forhealthcare conference. PMLR, 282300": "Liuyi Yao, Sheng Li, Yaliang Li, Mengdi Huai, Jing Gao, and Aidong Zhang. 2018.Representation learning for treatment effect estimation from observational data.Advances in Neural Information Processing Systems 31 (2018). Jinsung Yoon, James Jordon, and Mihaela Van Der Schaar. 2018. GANITE: Esti-mation of individualized treatment effects using generative adversarial nets. InInternational Conference on Learning Representations. Yue Yu, Xuan Kan, Hejie Cui, Ran Xu, Yujia Zheng, Xiangchen Song, YanqiaoZhu, Kun Zhang, Razieh Nabi, Ying Guo, et al. 2022. Learning Task-AwareEffective Brain Connectivity for fMRI Analysis with Graph Neural Networks.arXiv preprint arXiv:2211.00261 (2022). Chengxi Zang and Fei Wang. 2020. Neural Dynamics on Complex Networks. InKDD 20: The 26th ACM SIGKDD Conference on Knowledge Discovery and DataMining, Virtual Event, CA, USA, August 23-27, 2020. ACM, 892902.",
  "A.1.1Proof of Theorem. 1": "Theorem 1. Let {0, 1} be the binary treatment values, andlet and denote the number of units and observed timestamplengths, respectively. Let = (Z | A = ), be the distributionof latent representation Z for the group of units with treatments at time . Let , , A be the initial state encoder, the ODE functionof treatment-induced GraphODE, and logits of predicting treatment. The necessary and sufficient condition for the min-max game inEq. (7) to be optimal is 0 = 1, (0,1 ).",
  "= argmax ,EC (C )V G | C .(25)": "Eq. (25) has the same form as the equation in Lemma. 1. Thensubstituting = C and = G in Lemma. 1, we have E(G | C) =E(G). In other words, G C. Therefore, we can also use theinverse form that E(C) = E(C | G) = E([Z, A] | G) for anyG, which concludes the proof of Theorem. 2.",
  "A.3Experimental Settings": "Datasets. In observational data, we only have outcomes under onetreatment trajectory but not the ground-truths of counterfactualoutcomes. Therefore, we follow to use semi-syntheticdata to evaluate CF-GODE. That is, the graph structure and node fea-tures are real, but treatments and potential outcomes are simulated.We use the social networks Flickr and BlogCatalog as in as the graph G. We follow these works to first encode the nodefeatures into low-dimensional embeddings (10-dimensional in thispaper) via LDA . We then follow to use Metis to split thegraph into training/validation/testing sets. To simulate treatmentand potential outcomes over time, use a longitudinalsimulation environment, which, however, assumes the units aremutually independent. We extend it into our multi-agent dynamicalsystems setting by considering the neighbor confounders and inter-ference. During the simulation, we are motivated by the vaccinesuse case. Specifically, treatment A denotes getting a vaccine or notat time of unit . The trajectory of A denotes the vaccine recordsover time, e.g., a unit may have a booster dose after the initial vac-cine. In this case, the time-dependent covariates X could be thehealth condition, static covariates V could be race or educationalbackground (assuming it does not change during the study) and po-tential outcome Y could be immunity to the virus. As discussed inSec. 3.1, the potential outcome Y is essentially a part of X. This isa common setting in longitudinal causal inference studies .",
  "=": "=3), to mimic that a units own confounding factors should affectit more than neighbors. Note X is the average time-dependentcovariates until . This reflects that past time-dependent covariatesalso affect the treatment. We set = = 5 as adjustments.Potential outcome simulation. We follow to use aPharmacokinetic-Pharmacodynamic (PK-PD) model to sim-ulate the continuous trajectory. PK-PD model is a popular bio-mathematical model and a natural fit for our vaccine use case. Asmentioned above, Y is essentially a part of X. Therefore we di-rectly simulate the trajectory of X :",
  ",(27)": "where controls the effects of time-dependent covariates on futurepotential outcomes. O = V denote the effects of static con-founders on potential outcomes, where represents this mech-anism. , , and are degrees of time-dependent covari-ates, neighbor time-dependent covariates, static covariates andneighbor static covariates, respectively. Their default values are = [0.001, 00033, 0.001, 0.00033] (",
  "= 3). and control the strengths of treatment and interference. We": "set them as = [0.03, 0.01]. The values also reflect that aunits own covariates and treatment should have stronger effects onits future potential outcomes than neighbors. In reality, the effectsof vaccines on providing protection decrease over time. To mimicthis phenomenon, we use the following decay function to modelthe effects of treatments over time as in .",
  "NotationDescription": "GGraph that represents multi-agent dynamical systemVNode set in GEEdge set in GVStatic unit featuresXTime-dependent covariates at time ATreatment at time YObserved outcomes at time Y ( = ) Potential outcomes under treatment XTime-dependent covariates collections up to ATreatment collections up to YObserved outcomes collections up to HPast observationsANTreatments of node s first-order neighborsANTreatments of nodes that arebeyond s first-order neighborsGInterference summary variableZContinuous latent trajectory for node CConcatenation of Z and A()Interference summary function()ODE function ()Initial state encoder function ()Gradient reversal layerY()Outcome prediction layerA()Treatment prediction layerG()Interference prediction layerNumber of nodes in VNumber of observed timestamps Loss function of outcome predictionLoss function of treatment predictionLoss function of interference predictionAWeight of treatment balancingGWeight of interference balancing"
}