{
  "Abstract": "Online controlled experiments, commonly referred to as A/B testing, are widely used in many Internet companiesfor data-driven decision-making regarding feature modifications and product releases. However, a significantchallenge remains in methodically evaluating how each code or feature change affects millions of users whoexhibit considerable heterogeneity across various dimensions such as countries, ages, and devices. The AverageTreatment Effect (ATE) framework, which is the foundation of the A/B testing approach used by many companies,is unable to identify the heterogeneity of treatment effects on users with varying characteristics. This paperintroduces statistical techniques designed to systematically and precisely pinpoint the Heterogeneous TreatmentEffect (HTE) within any specific user cohort, like mobile device type or country. Additionally, these methods helpdetermine which user factors, such as age or gender, contribute to the variability in treatment effects observedduring an A/B test. Through the application of these methods to both simulated and real-world experimentaldata, we demonstrate their robust performance in maintaining a controlled, low False Discovery Rate (FDR).Simultaneously, they offer valuable insights into the heterogeneity of identified user groups. We have implementeda toolkit based on these methods and utilized it to assess the HTE across numerous A/B tests at Snap.",
  "Introduction": "Controlled experiments, also known as A/B testing, have become a standard method for assessing and enhancing new productconcepts across internet companies. Numerous IT companies, possessing extensive and large-scale data, have developed internalA/B testing platforms to address their intricate experimentation requirements. At Snap, the utilization of A/B testing has substantiallyincreased in the last two years. The in-house platform currently manages hundreds of concurrent experiments at any moment. Eachexperiment automatically generates results for hundreds to thousands of varied online metrics. As experimentation gains popularity, there is an increasing demand for experimenters to understand not only the overall impacton metrics in an A/B test but also the reasons behind metric changes and the specific user segments driving these changes. Suchinsights into user heterogeneity can assist experimenters in devising strategies to enhance the product. For instance, in a recentexperiment, we observed that a decline in a metric was primarily influenced by users with the highest number of snap views. Thisobservation led us to concentrate on understanding the engineering and design aspects when a user has a large number of snap stacksto load. Consequently, we were able to pinpoint a significant performance problem that was causing the metric to drop. Indeed, wehave encountered numerous instances where users react differently to the same experimental treatment. Furthermore, the abundance of data presents a significant risk of false discoveries, often due to a statistical phenomenon referred toas \"multiple testing\". Given the hundreds of thousands of user characteristics available to internet companies, user groups can beformed in millions of different ways. If a \"naive\" approach is taken, simply calculating and comparing the estimated effect based onusers within groups, it is easy to find groups with treatment effects that significantly deviate from the average, regardless of whetheractual heterogeneity exists. The objective of our work is to bridge this gap by offering rigorous statistical methods and a toolkit capable of detecting HeterogeneousTreatment Effects (HTE) while addressing the potential issue of multiple testing by controlling the false positive rate (FDR). Thistoolkit has been deployed and is in use at Snap. In this paper, we explore the rationale for using FDR and contrast two statisticalmethods that manage FDR, using both simulated results and actual experimental data. Based on the methods selected, we willdiscuss solutions to two questions that experimenters and practitioners are keen to understand regarding HTE:",
  "Average Treatment Effect vs. Heterogeneous Treatment Effect": "In an A/B test, users are randomly divided into a treatment group and a control group, and the metrics of interest are observedfor all users. The Rubin Causal Model is frequently employed in A/B testing as a statistical framework for causal inference. LetYi(Ti) represent the potential outcome for the i-th user, where Ti = 1 if the i-th user is in the treatment group and Ti = 0 if the i-thuser is in the control group. Consequently, i = Yi(1) Yi(0) denotes the causal effect of the treatment for the i-th unit, and theaverage causal effect across all users, , is defined as the Average Treatment Effect (ATE). It is important to note that the ATE isnot directly observable since Yi(0) and Yi(1) cannot be known simultaneously. This is recognized as the \"fundamental problem ofcausal inference\". However, the estimator Yi|Ti = 1 Yi|Ti = 0 is unbiased for the ATE when two specific assumptions are metand is commonly used to estimate the ATE in A/B testing.",
  "Assumption 2. Unconfoundedness: Ti is independent of (Yi(0), Yi(1)) given Xi, where Xi is a set of pre-treatment variables for thei-th user, such as age, gender, country, etc": "However, analysis based solely on ATE is sometimes insufficient for obtaining precise and meaningful insights. As mentioned earlier,we have observed numerous cases where a single feature change can impact different users differently. The estimation of ATE isnot an effective measure for a heterogeneous population, as it may exaggerate the treatment effect for one sub-population whileunderestimating it for another. To investigate heterogeneous treatment effects, it is necessary to consider the conditional averagetreatment effect, defined as: (x) = E[Yi(1) Yi(0)|Xi = x], where Xi represents a set of pre-treatment variables for the i-th user. Accurately estimating the conditional average treatment effect (x) for all values of x is highly beneficial for detecting heterogeneoustreatment effects because (x) provides the conditional average treatment effect for the subpopulation defined by the covariates x.For instance, if the covariate is country, the covariate space can be partitioned into countries, and (x) represents the conditionalaverage treatment effect for users in country x. If (x) is statistically different from the average treatment effect , then country x isconsidered heterogeneous.",
  "Naive Approaches and their Caveats": "In this section, we outline some prevalent practices used by practitioners that could result in the spurious discovery of HTE. Supposewe have users from various countries and wish to identify which countries exhibit treatment effects different from the ATE for aparticular metric. A straightforward approach to detect heterogeneous countries involves first conducting a two-sample t-test on theobservations from each country to obtain a two-sided p-value for each country, and then selecting countries with a p-value less than0.05 as the result. We will refer to this method as the \"naive approach\".",
  "False Discovery Rate Controlled HTE Detection": "Due to the limitations of the methods discussed in the previous section, we introduce methods for HTE detection that addressthe multiple testing problem while maintaining sufficient statistical power. To manage the multiple testing issue and reduceconservativeness, Benjamini and Hochberg introduced the concept of the false discovery rate (FDR), which is defined as follows:",
  "Detection for Heterogeneous Subgroups": "When conducting an A/B testing experiment, it is often important to identify which subgroups of users exhibit treatment effectsdifferent from the ATE. For example, at Snap, with users from over 200 countries, we are interested in determining which countrieshave higher or lower treatment effects compared to the average for the metric of interest. In this process, it is crucial to minimize the number of false discoveries in our results. To achieve this, we utilize the Benjamini-Hochberg (BH) procedure to control the FDR. The BH procedure is known to control the FDR if the test statistics are independent orsatisfy the positive regression dependence on a subset property. It is one of the most widely used FDR control methods due to itssimplicity. For instance, suppose we have p-values from m independent hypothesis tests H1, ..., Hm ranked in ascending order:p(1), ..., p(m), and we aim to control the FDR at level q. The BH procedure identifies the largest k such that p(k) k",
  "mq and rejectsthe null hypothesis for all H(i) where i k. By doing so, it theoretically ensures that the FDR is controlled below q": "To detect heterogeneous subgroups, it is necessary to estimate the conditional average treatment effects defined in equation (3) forthe subgroups. Although individual treatment effect values are not available due to the fundamental problem of causal inference, wecan construct a transformed outcome (TO) for each user as an alternative measure of individual treatment effect. Let Y obsibe theobserved outcome for the i-th unit. Additionally, let p be the assignment probability, which, in practice, is the traffic percentageassigned to the treatment group in an A/B test. The transformed outcome for the i-th unit, Y i , is then defined as:",
  "A beneficial property of the TO is that, under the unconfoundedness assumption, the conditional expectation E[Y i |Xi = x] equalsthe conditional average treatment effect (x)": "We propose the following method, which combines the BH method and Transformed Outcome, to detect heterogeneous subgroups.Suppose we have n users from p subgroups, and we want to identify subgroups with heterogeneous treatment effects that differ fromthe average treatment effect with a controlled FDR. We propose the following procedure, which we call the HTE-BH method:",
  "Step 4: Apply the BH procedure to the p-values to finalize the list of selected heterogeneous subgroups": "The design matrix X created in Step 1 is orthogonal in this scenario, so the p-values derived from the linear regression are independent.Consequently, the BH procedure can control the FDR at a pre-specified level q. In Step 2, we subtract the estimated ATE from thetransformed outcomes to detect subgroups with treatment effects different from the ATE. For simplicity, we treat the estimatedATE as a parameter. Although this overlooks the fact that the estimated ATE is a random variable, it has practical relevance aspractitioners are typically interested in observing which subgroups are statistically different from the observed average treatmenteffect across all users in an experiment. Note that obtaining p-values in the manner described in Step 3 is equivalent to obtainingp-values from running independent t-tests for all subgroups.",
  "Detection for Heterogeneous Factors": "In addition to detecting heterogeneous subgroups, identifying the factors that contribute to the heterogeneity of treatment effects isanother crucial task in practice. At Snap, we have anonymously constructed hundreds of user properties, including demographicinformation such as age and gender, as well as user engagement levels, such as how users interact with snaps, stories, or discover. Often, when presented with subtle experimental results, we are unsure which of these factors to investigate further. By pinpointingthe factors contributing to the heterogeneity in treatment effects, we can more effectively delve into the relevant factors and deriveinsights. The HTE-BH method is straightforward and easy to implement for detecting heterogeneous subgroups but is not suitablefor detecting heterogeneous factors because, in this case, we cannot construct an orthogonal design matrix in Step 1 of the HTE-BHmethod. Therefore, we propose using the Knockoff method to control the FDR for heterogeneous factors. The Knockoff is a recently proposed FDR control method. Suppose the response of interest, y, follows the classical linear model:y = X + , where y Rn is a vector of y, X Rnp is any fixed design matrix, is a vector of unknown coefficients, and N(0, 2I) is Gaussian error. Note that n is the number of observations and p is the number of variables. For the Knockoffmethod, we assume that n 2p, which is reasonable in practice because we are likely to have more observations than variables inmost A/B tests.",
  "Step 3: Calculate a data-dependent threshold T such that the FDR of the knockoff selection set S := {j : Wj T} is lessthan or equal to the pre-specified level q": "In our proposal, we use the equi-correlated method to obtain the non-negative vector s used in Step 1 to construct the knockoffmatrix X. The equi-correlated method suggests using sj = min{2min(), 1} for all j, where min is the smallest eigenvalue of. After obtaining this s, we construct X using the formula: X = X(I 1diags) + UC, where U is an n p orthonormalmatrix satisfying U T X = 0, and C is a Cholesky decomposition satisfying CT C = 2diags diags1diags. There are numerous options available for computing the statistics Wjs in Step 2. We choose to use Lasso to compute the statisticsWjs. Let X = [X X] Rn2p be the augmented design matrix. Recall the Lasso problem: minimize||y X||22 + ||||1. Define Zj = sup{ : j() = 0}, which is the largest tuning parameter that first allows the j-th variable to enter themodel. Note that (Zj, Zj+p) is a pair corresponding to the j-th original variable and its knockoff. We then calculate Wj as:Wj = (Zj Zj+p) sign(Zj Zj+p), for j = 1, ..., p.",
  "We propose the following procedure to detect the variables that contribute to the heterogeneity in treatment effects while controllingthe FDR. We call this the HTE-Knockoff method:": "Step 1: Construct a design matrix X based on the set of pre-treatment variables. Step 2: Calculate the transformed outcomes Y for all users based on the formula in Equation (5), and then subtract theestimated ATE, Y (1) Y (0), from all transformed outcomes. Let Y be the vector of the resulting outcomes.",
  "Step 3: Create a knockoff matrix X of X": "Step 4: Run a Lasso regression using Y as the response and X = [X X] as the design matrix. Step 5: Follow the procedure of the Knockoff method to obtain the knockoff selection set of heterogeneous variables. Note that our proposed HTE-Knockoff method can also detect heterogeneous subgroups because it works for any full-rank designmatrix, regardless of orthogonality. Additionally, the HTE-Knockoff method is applicable when Xi is a set of variables includingboth categorical and continuous variables, but we need to be careful in constructing the design matrix when there are more than onecategorical variables in Xi.",
  "Results": "We apply the HTE-BH and HTE-Knockoff methods to two real experimental datasets. In the first experiment, both methods yieldnearly identical selections for heterogeneous subgroups. If we were to use the naive approach, it would select many more subgroups,clearly indicating numerous false positives. The HTE results reveal drastically different effects in English-speaking countries versusnon-English-speaking countries. Retrospectively, we understood that the new layout in the experiment favored non-English contentwhile suppressing high-quality content in English. In the second experiment, the HTE-BH method selects one subgroup as heterogeneous, whereas the HTE-Knockoff method selectsnone. This likely represents a scenario where the true treatment effects are too small to be detected, causing the HTE-Knockoff",
  "Conclusion": "In this paper, we propose the HTE-BH method for detecting heterogeneous subgroups with treatment effects different from theaverage, and the HTE-Knockoff method for identifying factors contributing to the heterogeneity in treatment effects. While theHTE-BH method is easier to implement, the HTE-Knockoff method has a broader application as it can also be used to detectheterogeneous factors. Our proposed methods demonstrate good detection power while addressing the multiple testing problem bycontrolling the FDR level. Despite their wide application scenarios, our current methods have some limitations and could be improved in future research. Thefirst limitation is the assumption that the true model is a linear regression model with Gaussian error; the theoretical propertiesof the original Knockoff method are based on this assumption. Although we show that the Knockoff method can still performwell in controlling FDR in some non-Gaussian error cases, there is no theoretical proof for such robustness. Additionally, thetrue relationship between the treatment effect and the variables may not always be linear, making the use of linear regressioninappropriate. Recently, a model-free knockoff method has been proposed, which, under certain conditions, can work on any kind ofnon-linear model. This idea could be useful if we aim to extend the HTE-Knockoff procedure to a more generalized setting in futurework. Another unresolved issue is scalability. We attempted to use the transformed design matrix to conduct HTE detection on multipleexperiments, but this resulted in increased computational complexity. This problem warrants further investigation because mostcompanies have a large number of A/B test results available, and it is not feasible to apply the HTE detection method to eachexperiment individually."
}